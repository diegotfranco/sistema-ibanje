name: Build and Deploy Full Stack

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          # Set Node environment to production
          echo "NODE_ENV=production" >> .env

          # Docker network hosts
          echo "POSTGRES_HOST=postgres" >> .env
          echo "REDIS_HOST=redis" >> .env

          # Database, Redis, and MinIO Secrets
          echo "POSTGRES_DB='${{ secrets.POSTGRES_DB }}'" >> .env
          echo "POSTGRES_USER='${{ secrets.POSTGRES_USER }}'" >> .env
          echo "POSTGRES_PASSWORD='${{ secrets.POSTGRES_PASSWORD }}'" >> .env
          echo "REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'" >> .env
          echo "MINIO_ROOT_USER='${{ secrets.MINIO_ROOT_USER }}'" >> .env
          echo "MINIO_ROOT_PASSWORD='${{ secrets.MINIO_ROOT_PASSWORD }}'" >> .env

          # Application and SMTP Secrets
          echo "FRONTEND_BASE_URL='${{ secrets.FRONTEND_BASE_URL }}'" >> .env
          echo "SMTP_HOST='${{ secrets.SMTP_HOST }}'" >> .env
          echo "SMTP_PORT='${{ secrets.SMTP_PORT }}'" >> .env
          echo "SMTP_USER='${{ secrets.SMTP_USER }}'" >> .env
          echo "SMTP_PASS='${{ secrets.SMTP_PASS }}'" >> .env
          echo "EMAIL_FROM='${{ secrets.EMAIL_FROM }}'" >> .env

      - name: Build and Deploy Services
        run: |
          # Build new images for services that have changed
          docker compose build
          # Bring up all services, recreating containers for services that were rebuilt
          docker compose up -d --force-recreate --remove-orphans
          # Clean up old, unused images
          docker image prune -f
